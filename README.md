# Excel数据处理工具

基于 Streamlit 的 Excel 数据处理工具，用于根据 ERP 库存数据更新订单表中的所需数量。

## 功能特性

- **Web 界面操作**: 友好的用户界面，无需命令行操作
- **命令行支持**: 提供命令行脚本，支持批量处理
- **智能数据匹配**: 自动从商家编码中提取产品型号
- **智能列识别**: 自动识别订单表中的产品型号列和目标列，支持多种列名格式
- **灵活配置**: 支持手动选择列和数据起始行，适应不同订单表格式
- **差值计算**: 自动计算 30 天销量与实际可用数的差值
- **格式保留**: 处理后的文件保留原始格式、图片和样式
- **相似度匹配**: 显示 ERP 中存在但订单表中缺失的产品型号，并提供相似度推荐

## 快速开始

### 安装依赖

```bash
pip install -r requirements.txt
```

### 启动 Web 应用

```bash
streamlit run streamlit_app.py
```

访问 `http://localhost:8501` 使用 Web 界面。

### 命令行使用

```bash
python process_excel.py <ERP库存表路径> <订单表路径>
```

示例：

```bash
python process_excel.py excels/from/库存表.csv excels/dist/订单表.xlsx
```

## 使用说明

### Web 界面流程

1. **上传 ERP 库存表**: 上传包含库存数据的 Excel/CSV 文件
2. **上传订单表**: 上传需要更新的订单 Excel 文件（.xlsx 格式）
3. **配置列信息**: 系统会自动识别产品型号列和目标列，您也可以手动选择
4. **开始处理**: 点击按钮开始处理数据
5. **下载结果**: 处理完成后下载更新后的 Excel 文件

### 文件要求

#### ERP 库存表（from 文件）

- 支持格式：`.xlsx`, `.xls`, `.csv`
- 必需列：
  - `实际可用数`: 库存可用数量
  - `30天销量`: 近 30 天销售数量
  - `商家编码`: 包含产品型号的编码（格式如：`商家-产品型号`）

#### 订单表（dist 文件）

- 支持格式：`.xlsx`、`.xls`（.xls 格式会自动转换为 .xlsx）
- 必需列：
  - 产品型号列：支持多种列名，如：产品型号、商品货号、货号、型号等
  - 目标列：要更新的数量列，支持多种列名，如：所需数量、数量、订货数量、进货数量等
- 系统会自动识别列名，也可手动选择

### 支持的订单表格式

系统支持多种订单表格式，自动识别以下列名：

| 列类型 | 支持的列名关键词 | 示例 |
|--------|------------------|------|
| 产品型号列 | 产品型号、商品货号、货号、型号、model、code | DSPIAE: 产品型号<br>泉微模型: 商品货号 |
| 目标列 | 所需数量、数量、订货数量、进货数量、数量/个、quantity、qty | DSPIAE: 所需数量/个（标箱倍数）<br>泉微模型: 数量 |

如果您的订单表使用其他列名，系统会在界面上显示所有可用的列供您选择。

### 数据处理逻辑

1. **提取产品型号**: 从商家编码中提取产品型号（取 `-` 后的部分）
2. **计算差值**: `差值 = 实际可用数 - 30天销量`
3. **数据匹配**: 根据产品型号将差值填入订单表
4. **过滤规则**: 只填入非负数，负数会被跳过
5. **灵活配置**: 支持设置数据起始行，适应不同表头结构

### 输出结果

- 处理后的文件名格式：`订单表_更新_YYYYMMDD_HHMMSS.xlsx`
- 保留原始文件的所有格式、图片和样式
- 显示更新数量统计和跳过的负数数量
- 显示 ERP 中存在但订单表中缺失的产品型号及相似度推荐

## 技术栈

- **Python 3.11**
- **Streamlit**: Web 应用框架
- **Pandas**: 数据处理和分析
- **openpyxl**: Excel 文件读写

## 项目结构

```
pms_A/
├── streamlit_app.py       # Streamlit Web 应用
├── process_excel.py       # 命令行处理脚本
├── requirements.txt       # Python 依赖
├── .devcontainer/         # Dev Container 配置
│   └── devcontainer.json
├── excels/                # Excel 数据目录（已忽略）
│   ├── from/              # ERP 库存表
│   └── dist/              # 订单表
└── .gitignore             # Git 忽略规则
```

## 开发容器

项目配置了 Dev Container，支持在 GitHub Codespaces 和 VS Code 中直接使用：

- Python 3.11 环境
- 自动安装依赖
- 自动启动 Streamlit 应用（端口 8501）

## 注意事项

- ERP 库存表的 `商家编码` 列中产品型号需要使用 `-` 分隔符
- 订单表中的产品型号需与 ERP 库存表中的产品型号完全匹配
- 处理后的文件是通过复制原始文件后修改，不会影响原文件
- 对于嵌入图片，openpyxl 可能无法正确显示，但图片数据会保留在文件中
- 系统支持多种订单表格式，会自动识别产品型号列和目标列
- 如果自动识别不正确，可以手动选择正确的列
- `.xls` 格式文件会自动转换为 `.xlsx` 格式进行处理
